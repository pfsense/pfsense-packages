<?php
set_time_limit(900);
ini_set('max_execution_time', 900);

$statusurl = "status_captiveportal.php";
$logurl = "diag_logs_auth.php";

require("guiconfig.inc");
require_once("/etc/inc/functions.inc");



include("head.inc");

function niceName($name){
		$name = str_replace('_',' ',$name);
		if( !ctype_upper ( substr($name,0,1) ) ){
				return strtoupper(substr($name,0,1)).substr($name,1);
		}
		else{
				return $name;
		}
}
?>
<?php include("fbegin.inc"); ?>
<body link="#0000CC" vlink="#0000CC" alink="#0000CC">
	<link rel='stylesheet' href='./css/bootstrap.css'/>
	<style>
.logo {
	height:48px;
	border-radius:5px;
	margin-right:10px;
	vertical-align:middle;
	border:0;
}
h4 {
	color: #0088cc;
	 font-size: 1.4em;
  font-weight: 400;
  letter-spacing: normal;
  line-height: 27px;
  margin: 0 0 14px 0;
}
h4 small {
	font-size:75%;
	 font-weight: normal;
  line-height: 1;
  color: #999999;
}
#right {
	padding-bottom:0px !important;
}
.breadcrumb > li + li:before {
	display: inline;
	font-size: 16px;
	height: auto;
	content: ">";
	font-weight: 300;
	text-shadow: none;
	padding: 0 5px;
}
.ui-tooltip {
	padding: 8px;
	position: absolute;
	z-index: 9999;
	-webkit-box-shadow: 0 0 5px #aaa;
	box-shadow: 0 0 5px #aaa;
}
body .ui-tooltip {
	border-width: 2px;
}

</style>
<script language="javascript" src="javascript/jquery-1.11.1.min.js"></script>
<script language="javascript" src="javascript/jquery/jquery-ui-1.11.1.min.js"></script>
<script>
	
var niceName = function(name){
		name = name.replace('_',' ');
	if ( name.charAt(0) != "" ) {
		if ( name.charAt(0) !== name.toUpperCase().charAt(0) ) {
			name = name.charAt(0).toUpperCase()+name.substr(1);
		}
	}
	return name;
}

jQuery(document).ready(function() {
	
	
	
		jQuery(document).on('click','#license_button',function(){
			
			//passé la div licence en mode, installation d'un package et faire un affichage à l'install package natif pfsense
			var data = "key="+jQuery("#license_key").val()+"&rdm="+Math.random();
			jQuery("#license").html("<div  class='row' style='text-align:center;margin-bottom:20px;'><span style='color:#08C;'>The package request has been made, wait for validation</span></div>");
			jQuery.ajax({
					url : "system_apps_by_packetapps_send_license.php",
					data : data,
					dataType : 'json',
					type : 'GET',
					success : function(res){
						jQuery('#license').fadeOut(function(){
							jQuery('#license').html("<div  class='row' style='text-align:center;margin-bottom:20px;'><span style='color:#08C;'>"+res['text']+"</span></div>").fadeIn(function(){
								if( res['result'] == 1 ){
										var infos = res['infos'];
										jQuery('#prodList').append("<div class='col-xs-6'><div id="+infos['name']+" style='border: 1px solid #EDEDED;text-align:center;border-radius:5px;padding:5px 20px 5px 20px;margin:5px;background:#FAFAFA;box-shadow: 0px 0px 8px rgba(0,0,0,0.3);'><div class='row'><h4 style='text-align:left;'><img class='logo' src='logo/"+infos['name']+"'>"+niceName(infos['name'])+"  <small>( v"+infos['version']+" )</small></h4></div><div class='row'><div class='col-xs-12'><p style='text-align:justify'>"+infos['synopsis']+"</p></div></div><div class='row'><a href="+infos['index']+"><button class='btn-success' style='float:left;border-radius:5px'>Administrate</button></a><button class='deinstall btn-danger' style='float:right;border-radius:5px'>Uninstall</button></div></div></div>");
										jQuery('#license').fadeOut(function(){
											jQuery('#license').html("<div  class='row' style='text-align:center;margin-bottom:20px;'><span style='color:#08C;'><a href='http://dev.elonet.fr/packetapps/browse-app.php'>Browse and suscribe to a product.</a> Then copy/paste setup key below</span></div><div  class='row' style='text-align:center;'><input id='license_key' type='text' placeholder='Setup key.' style='text-align:center;margin-right:15px;'/><button id='license_button' class='btn btn-info'>Install now</button>	</div>").fadeIn();				
										});
										if ($('#prodList').length == 0 ) {
												$('#list_title').text("You don't have any package installed");
										}
										else if($('#prodList').length == 1 ){
												$('#list_title').text("Your installed product");
										}
										else{
												$('#list_title').text("Your installed products");
										}
								}
								else{
									jQuery('#license').fadeOut(2000,function(){
										jQuery('#license').html("<div  class='row' style='text-align:center;margin-bottom:20px;'><span style='color:#08C;'><a href='http://dev.elonet.fr/packetapps/browse-app.php'>Browse and suscribe to a product.</a> Then copy/paste setup key below</span></div><div  class='row' style='text-align:center;'><input id='license_key' type='text' placeholder='Setup key.' style='text-align:center;margin-right:15px;'/><button id='license_button' class='btn btn-info'>Install now</button>	</div>").fadeIn();
									});
								}
							});
						});
						
					},
					error : function(){
						alert("A technical error occured during license key validation, try again");
						jQuery('#license').html("<div  class='row' style='text-align:center;margin-bottom:20px;'><span style='color:#08C;'><a href='http://dev.elonet.fr/packetapps/browse-app.php'>Browse and suscribe to a product.</a> Then copy/paste setup key below</span></div><div  class='row' style='text-align:center;'><input id='license_key' type='text' placeholder='Setup key.' style='text-align:center;margin-right:15px;'/><button id='license_button' class='btn btn-info'>Install now</button>	</div>").fadeIn();
					}
			});
		});
		
		
		jQuery(document).on('click','.deinstall',function(){
			var product = jQuery(this).parent().parent();
			var product_name = product.attr('id');
			var r = confirm("Are you sure you really want to uninstall "+product_name);
			if (r == true) {
				
				var data = 'pkg='+product_name+"&rdm="+Math.random();
				jQuery.ajax({
						url : "system_apps_by_packetapps_uninstall.php",
						data : data,
						dataType : 'json',
						type : 'GET',
						success :function(res){							
							jQuery('#license').fadeOut(function(){
								jQuery('#license').html("<div  class='row' style='text-align:center;margin-bottom:20px;'><span style='color:#08C;'>"+res['text']+"</span></div>").fadeIn(function(){
									if( res['result'] == 1 ){
										product.fadeOut(1000,function(){
												product.parent().remove();
											jQuery('#license').fadeOut(function(){
												jQuery('#license').html("<div  class='row' style='text-align:center;margin-bottom:20px;'><span style='color:#08C;'><a href='http://dev.elonet.fr/packetapps/browse-app.php'>Browse and suscribe to a product.</a> Then copy/paste setup key below</span></div><div  class='row' style='text-align:center;'><input id='license_key' type='text' placeholder='Setup key.' style='text-align:center;margin-right:15px;'/><button id='license_button' class='btn btn-info'>Install now</button>	</div>").fadeIn();				
											});
										});
										if ($('#prodList').length == 0 ) {
												$('#list_title').text("You don't have any package installed");
										}
										else if($('#prodList').length == 1 ){
												$('#list_title').text("Your installed product");
										}
										else{
												$('#list_title').text("Your installed products");
										}
									}
									else{
										jQuery('#license').fadeOut(function(){
											jQuery('#license').html("<div  class='row' style='text-align:center;margin-bottom:20px;'><span style='color:#08C;'><a href='http://dev.elonet.fr/packetapps/browse-app.php'>Browse and suscribe to a product.</a> Then copy/paste setup key below</span></div><div  class='row' style='text-align:center;'><input id='license_key' type='text' placeholder='Setup key.' style='text-align:center;margin-right:15px;'/><button id='license_button' class='btn btn-info'>Install now</button>	</div>").fadeIn();
										});
									}
								});
							});
						},
						error :function(){
							alert("Error during "+product_name+" deinstallation. It seems there a problem with Apps.");
							jQuery('#license').html("<div  class='row' style='text-align:center;margin-bottom:20px;'><span style='color:#08C;'><a href='http://dev.elonet.fr/packetapps/browse-app.php'>Browse and suscribe to a product.</a> Then copy/paste setup key below</span></div><div  class='row' style='text-align:center;'><input id='license_key' type='text' placeholder='Setup key.' style='text-align:center;margin-right:15px;'/><button id='license_button' class='btn btn-info'>Install now</button>	</div>").fadeIn();
						}
				});
			}
		});
		
		jQuery(document).on('click','.help',function(){
			window.location.replace("http://dev.elonet.fr/packetapps/help.php");
		});
		
		$(document).tooltip({
			items: ".tooltip-button",
			content: function() {
				var element = $(this).attr('data-tooltip');
				return element;
			},
			position: { my: "center top", at: "center bottom" },
			open: function (event, ui) {
				ui.tooltip.css("max-width", "1000px");
				
			}
		});

});


</script>
    <div class='row' style='text-align:center;margin-bottom:50px;height:100px;'>
		<img src='http://dev.elonet.fr/packetapps/img/logo.png' class='col-xs-3' alt='Apps by Packetapps.com'/>
		<div class="col-xs-9">
			<span style='color:#08C;font-size:x-large;margin-right:30%;'>Apps by PacketApps.com</span>
			<div  style="text-align:center;margin-left:30%;margin-top:5px;font-size:12px;" id="one-two-three">
					<ul id='oneTwoThree' class='breadcrumb' style='background-color:transparent;'>
							<li style="cursor:pointer;"><span class="tooltip-button" style="margin-left:5px" data-tooltip="Click here to find apps on www.packetapps.com">Find apps</span></li>
							<li style="cursor:pointer;"><b><span class="tooltip-button" style="margin-left:5px" data-tooltip="Once you have chosen apps and device, paste your setup key to this page and the app will be installed">Deploy apps</span></b></li>
					</ul>
			</div>
		</div>
	</div>
	
	<div class='row'  style='color:#08C;text-align: center;'>
		<div class="col-xs-12">
			<span >PacketApps.com is a marketplace for apps, services, and hardwares. <a href='http://dev.elonet.fr/packetapps/browse-app.php'>Go browse it !<a/></span>
		</div>
		<hr style='width:70%;margin-top : 25px;margin-bottom : 25px;'></hr>
	</div>
	<!-- We start defining a div which check if the App was associated to a device on packetapps.com -->
	<!-- how chek if device associated? -->
	

	<!-- show list of installed package -->
	<!-- also permit to add a new package via his license key -->
	<div  class='row' id="licences" style="padding:10px;margin-top:20px;margin-bottom:25px;text-align:center;">
		<div class='col-xs-12' style='text-align:center;'>
			<div class='row' style='margin-bottom:20px;'>
				<?php $pkgs_xml = simplexml_load_file("/usr/local/appsbypacketapps/config.xml");
				$pkgs = $pkgs_xml->xpath("//package");
				if( count($pkgs) == 0 ){ ?>
						<span style='color:#08C;' id='list_title'>You don't have any package installed</span>
				<?php }
				else if( count($pkgs) == 1 ){ ?>
						<span style='color:#08C;' id='list_title'>Your installed product</span>
				<?php }
				else{ ?>
						<span style='color:#08C;' id='list_title'>Your installed products</span>
				<?php } ?>
			</div>
			<div  id='prodList' class='row' style='margin-left:5px;'>
				<?php foreach( $pkgs as $pkg ){ ?>
						<div class='col-xs-6'>
							<div id="<?php echo $pkg->name;?>" style="border: 1px solid #EDEDED;text-align:center;border-radius:5px;padding:5px 20px 5px 20px;margin:5px;background:#FAFAFA;box-shadow: 0px 0px 8px rgba(0,0,0,0.3);">
									<div class='row'>
										<h4 style='text-align:left;'><img class='logo' src='logo/<?php echo $pkg->name;?>'><?php echo niceName($pkg->name);?>  <small>( v<?php echo $pkg->version;?> )</small></h4>
									</div>
									<div class='row'>
										<div class="col-xs-12">
											<p style='text-align:justify'>
												<?php echo $pkg->synopsis;?>
											</p>
										</div>
									</div>
									<div class='row'>
											<a href="<?php echo $pkg->index;?>"><button class='btn-success' style='float:left;border-radius:5px'>Administrate</button></a>
											<button class="deinstall btn-danger" style='float:right;border-radius:5px'>Uninstall</button>
									</div>
							</div>
						</div>
				<?php } ?>
			</div>
		</div>
		<!-- License add div -->
		<div id="license" style='margin-top:30px';>
			<div  class='row' style='text-align:center;margin-bottom:20px;'>
				<span style='color:#08C;'><a href='http://dev.elonet.fr/packetapps/browse-app.php'>Browse and suscribe to a product.</a> Then copy/paste setup key below</span>
			</div>
			<div  class='row' style='text-align:center;'>
				<input id="license_key" type="text" placeholder='Setup key.' style='text-align:center;margin-right:15px;'/>
				<button id="license_button" class='btn btn-info'>Install now</button>
			</div>
		</div>
	</div>
	<hr></hr>
	<div id='footer-app' style="margin-top:25px;">
		<div class='row'>
			<div class='col-xs-4'>
				<center>
					<a href="http://dev.elonet.fr/packetapps/help.php"><button class="btn btn-info btn-xs">Common questions</button></a>
				</center>
			</div>
			<div class='col-xs-4'>
				<center>
					<a href='http://dev.elonet.fr/packetapps/forum.php'><button class="btn btn-info btn-xs">Forum</button></a>
				</center>
			</div>
			<div class='col-xs-4'>
				<center>
					<a href='http://dev.elonet.fr/packetapps/dashboard.php'><button class="btn btn-info btn-xs">My dashboard</button></a>
				</center>
			</div>
		</div>
	</div>
<?php include("fend.inc"); ?>
</body>
</html>
